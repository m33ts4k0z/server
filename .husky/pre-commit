#!/usr/bin/env bash

# Allow skipping hooks with SKIP_HOOKS environment variable
if [ -n "$SKIP_HOOKS" ]; then
  exit 0
fi

# Check if nix is available and flake.lock exists (non-blocking)
if [ -f "flake.lock" ] && [ -n "$(find "flake.lock" -mtime +7 2>/dev/null)" ]; then
  if command -v nix-shell >/dev/null 2>&1; then
    # Check if we haven't re-executed ourselves yet
    if [ -z "$HOOK_NIX_SHELL" ]; then
      export HOOK_NIX_SHELL=1
      # Try to run with nix-shell, but don't fail if it doesn't work
      nix-shell -i "bash" -p bash prefetch-npm-deps jq nodejs nix-output-monitor "$0" 2>/dev/null && exit $?
      # If nix-shell failed, continue without it
    else
      nix flake update --extra-experimental-features 'nix-command flakes' -vL 2>/dev/null || true
      git add flake.lock 2>/dev/null || true
    fi
  fi
fi

# Run lint-staged
# --quiet: Only show errors, suppress informational output
# --no-stash: Don't stash changes (avoids backup issues on Windows)
# Disable colors to prevent ANSI escape codes
export NO_COLOR=1
export FORCE_COLOR=0

npx -y lint-staged --quiet --no-stash
